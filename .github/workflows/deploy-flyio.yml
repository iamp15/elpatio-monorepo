name: Deploy to Fly.io

on:
  push:
    branches: [main, master]
    paths:
      - "elpatio-backend/**"
      - "bot-telegram/**"
      - ".github/workflows/deploy-flyio.yml"
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    # Solo ejecutar si hay cambios en el backend
    if: |
      contains(github.event.head_commit.message, '[backend]') ||
      contains(github.event.head_commit.modified, 'elpatio-backend/') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend to Fly.io
        run: cd elpatio-backend && flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          echo "‚úÖ Backend desplegado exitosamente"
          echo "üåê URL: https://elpatio-backend.fly.dev"

  deploy-bot:
    name: Deploy Bot
    runs-on: ubuntu-latest
    # Solo ejecutar si hay cambios en el bot
    if: |
      contains(github.event.head_commit.message, '[bot]') ||
      contains(github.event.head_commit.modified, 'bot-telegram/') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Bot to Fly.io
        run: cd bot-telegram && flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          echo "‚úÖ Bot desplegado exitosamente"
          echo "ü§ñ Bot: elpatio-bot"
